
<style>
	#chartdiv {
	  width: 100%;
	  height: 310px;
	}
	</style>
{% extends './index.html' %}
{% load static %}


{% block extra_header %}
<link href="{% static 'webpages/ctn_bpf/barometer.css' %}" rel="stylesheet" type="text/css">
{% endblock %}
{% block content %}

<div class="d-flex d-none">
<div class="text-center">
	<b style="color:#aaa;" class="btn actu_date"></b>
</div>
<div style="color:#aaa;" class="btn">
	<span id = "clock" class="badge badge-primary" onload="currentTime()"></span>
</div>
</div>



<div id='main_content' {% if permissions == 0 %} class='d-flex' style="flex-direction: column-reverse;" {% endif %}>
	{% if permissions > 0 %}
	<div class="d-none">
		<input type="checkbox" id="cumul_periodes" name="">
		<label for="#cumul_periodes"></label>
	</div>
	<div class="proccess_section all_section d-none">
		<div class=" col-12 d-md-flex flex-wrap mb-4">
			<div class="d-flex flex-wrap col-lg-6 col-12">
				<div class="col-8 col-lg-8">
					<label> De la P&eacute;riode du : </label>
					<div class="d-flex justify-content-center">
						<select id='period_select' class="col-lg-12 form-control">
							<option value="0"> Toutes les P&eacute;riodes </option>
							{% for per in default_period.decoup_slip %}
							<option {% if default_period.m_logic_type == 3 and forloop.counter == this_period.month or default_period.m_logic_type == 2 and forloop.counter == this_week or default_period.m_logic_type == 1 and forloop.counter == this_period.isoweekday %} selected {% endif %} value="{{forloop.counter}}" class='week_plus'>{{per}}</option>
							{% endfor %}
						</select>
					</div>
				</div>
				<div class="col-4 col-lg-4">
					<label for="typeperiode">Ann&eacute;e</label>
					<input type="number" id="year_plan" value=2022 class="form-control">

				</div>
			</div>
			<div class="d-md-none my-3"></div>

			<div class="d-md-flex flex-wrap flex-column col-lg-6 col-12">
				<div><input id="cumul1" type="checkbox" name="">&nbsp;<label for="cumul1"> Obtenir la Progression cumulee</label></div>
				<div><input id="cumul2" type="checkbox" name="">&nbsp;<label for="cumul2"> Globalite des {{operations_name}}</label></div>
			</div>

		</div>
	</div>
	<div class="pl-2 mb-3 d-none">
		<div class="h5 title_div" style="width:99%;border-bottom:1Px solid #aaa;color:#aaa;font-family:quartz">Informations G&eacute;n&eacute;rales - {{actual_institution}} </div>
	
	</div>
	<div style="display:none;"  class="mt-4 mb-5">
		<div class="h4">
			Evolution - {{type_entity}}
		</div>
		<div id="myChartpro_block" style="min-height:300px;" class="flex-wrap d-flex">
		</div>
	</div>
	<!-- <div class="nav-align-top">
		<ul class="nav nav-pills flex-column flex-md-row mb-6">
		  <li class="nav-item">
			<a class="nav-link dropdown-toggle hide-arrow show"  data-bs-toggle="dropdown" aria-expanded="true"><i class="bx bx-user bx-sm me-1_5"></i> Account</a>
		 
		</li>
		  
		  <li class="nav-item">
			<a class="nav-link" href="pages-account-settings-notifications.html"><i class="bx bx-bell bx-sm me-1_5"></i> Notifications</a>
		  </li>
		  <li class="nav-item">
			<a class="nav-link active" href="javascript:void(0);"><i class="bx bx-link-alt bx-sm me-1_5"></i> Connections</a>
		  </li>
		</ul>
	  </div> -->
	  <div class="btn-group">
		<!-- <button type="button" class="btn btn-primary dropdown-toggle hide-arrow show" data-bs-toggle="dropdown" aria-expanded="true">
		  Hidden arrow
		</button>
		<ul class="dropdown-menu show" style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate(0px, 40px);" data-popper-placement="bottom-start">
		  <li><a class="dropdown-item" href="javascript:void(0);">Action</a></li>
		  <li><a class="dropdown-item" href="javascript:void(0);">Another action</a></li>
		  <li><a class="dropdown-item" href="javascript:void(0);">Something else here</a></li>
		  <li>
			<hr class="dropdown-divider">
		  </li>
		  <li><a class="dropdown-item" href="javascript:void(0);">Separated link</a></li>
		</ul>
	  </div> -->
 	
	
	  
		
	  </div> 
	<div  class="justify-content-center row ">
		<div style="" class=" d-flex flex-wrap col-lg-6 col-md-6 col-12">
			<div class='section_canver pt-1 col-12 col-lg-12'>
				
				 
			

	
	<div class="" style="height: 90%;">
		<div>
		Evolution	Du <small id="date_d">******</small> Au  <small id="date_f">********</small>
		  
			   <label> Progression : </label> <label class="progr_btn {% if actual_progression < 25 %} text-danger {% elif actual_progression < 75 %} text-warning {% else %} text-success {% endif %}" >
				   
			   <small id="progressions">**** % </small></label>
			<!-- <div class="pl-2 h3"><img src="{{actual_institution.img.url}}" style="width:40px;height:40px;border-radius:100%;">&nbsp;Evolution Globale</div> -->
			
					
				
			<div id="chartdiv"></div>
			<!-- <div class="card-footer">
				
		   </div> -->
		</div>
	</div>
	
				
			</div>

			<div style="display:nonse;" class='section_canver pt-1 col-12 col-lg-12'>
				<label style="width:100%;" class="text-center"> <a class="text-secondary" href="#">Couverture des Indicateurs</a></label>
				<canvas style="width:100%;" class="barometer_indic"></canvas>
				<div>
					<div class="d-flex w-100 justify-content-around flex-wrap">
						<div class="d-flex mb-2">
							<div class='' style="width:10px;height:10px;background:red"></div><div style="font-size:12px;">&nbsp;Critique</div>
						</div>
						<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:orange"></div><div style="font-size:12px;"> &nbsp; Faible </div>
						</div>
						<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:#d06910;"></div><div style="font-size:12px;"> &nbsp;Moyen </div>
						</div>
						<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:#a0a345"></div><div style="font-size:12px;"> &nbsp;Bon </div>
						</div>
						<div class="d-flex">
							<div style="width:10px;height:10px;background:green"></div><div style="font-size:12px;">&nbsp;Excellent</div>
						</div>
					</div>
				</div>
			</div>
			<div style="display:nonse;" class='section_canver pt-1 col-12 col-lg-12'>
				<label style="width:100%;" class="text-center"> <a class="text-secondary" href="#">Gestion du Budget</a></label>
				<div></div>
				<canvas style="width:100%;" class="barometer_budget"></canvas>
				<div>
					<div>
						<small>Budget consomme : </small>
						<small id="budget_consum_val"> </small>
					</div>
					<div class="d-flex w-100 justify-content-around flex-wrap">
						<div class="d-flex mb-2">
							<div class='' style="width:10px;height:10px;background:red"></div><div style="font-size:12px;">&nbsp;Critique</div>
						</div>
<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:#d06910;"></div><div style="font-size:12px;"> &nbsp;Moyen </div>
						</div>
						<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:orange"></div><div style="font-size:12px;"> &nbsp; Faible </div>
						</div>

						<div class="d-flex mb-2">
							<div style="width:10px;height:10px;background:#a0a345"></div><div style="font-size:12px;"> &nbsp;Bon </div>
						</div>
						<div class="d-flex">
							<div style="width:10px;height:10px;background:green"></div><div style="font-size:12px;">&nbsp;Excellent</div>
						</div>
					</div>
				</div>
			</div>
		</div>



		<div class=" col-md-6 d-flex flex-column justify-content-center" style="height: 100%;">
			<div class="">
				<div class="">

				
				<div class="pl-2 h3"><img src="{{actual_institution.img.url}}" style="width:40px;height:40px;border-radius:100%;">&nbsp;{{actual_institution}}</div>
				<!-- <div class="pl-2 h5"> {{actual_institution.nom}}</div> -->
			</div>
				<div class="section_div my-4">
					<div class="d-flex justify-content-between  flex-wrap">
						
						<div>
							<div class="">
								
							</div>
							<div class="">
								
								<label><small> G&eacute;n&eacute;ral</small>  Progression : </label> <label class="{% if actual_progression < 25 %} text-danger {% elif actual_progression < 75 %} text-warning {% else %} text-success {% endif %}"> {{operations_calcul}}% </label>
							</div>
						</div>

					</div>
				</div>
				<div class="section_div" style="display:none;">
					<div><small>Atteinte des Objectifs</small></div>
					<div class="col-12 d-flex flex-wrap justify-content-between">
						<div class="col-lg-12">
							<div class="flex-wrap col-md-12 d-flex ">
								<div class=" col-md-12">
									<div class="d-flex col-12">
										<div><i class="fas fa-square text-danger"></i>&nbsp;<label><small>Objectifs en faible progression</small>&nbsp;<span class="text-danger indi_faibles"></span>&nbsp;%</label></div>
									</div>
								</div>
								<div class="col-md-12">
									<div  class="d-flex col-12">
										<div><i class="fas fa-square text-success"></i>&nbsp;<label><small>Objectifs en bonne realisation</small>&nbsp;<span class="indi_forts text-success"></span>&nbsp;%</label></div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="section_div" style="display:none">
					<div> <small> Gestion Budgetaire </small> </div>
					<div class="d-flex justify-content-between">
						<div>
							<div class="">
								<small> </small>
							</div>
							<div class="">
								<label> Budget Prevu : </label> <label class="text-success"> {{finances}} {{finan_options}} </label>
							</div>
						</div>
						<div>
							<div class="">
								<small> </small>
							</div>
							<div class="">
								<label> Depenses effectives : </label> <label class=" {% if depenses_eff <= finances %} text-success {% else %} text-danger {% endif %}"> {{depenses_eff}} {{finan_options}} </label>
							</div>
						</div>
					</div>
				</div>
				<div id="accordionStyle1-1" class="accordion-collapse collapse" data-bs-parent="#accordionStyle1">
					<div class="accordion-body">
						<nav class="navbar navbar-expand-lg">
							<div class="container-fluid ">
								<div class="row">
									<div class="col-md-12">
		
									<div class="d-flex">
								<label for=" debut">Date Debut</label>
								  <input class="form-control me-2" type="date" value="{{actual_institution.date_creation|date:'Y-m-d'}}" name="date_debut" >
								  <label for="fin">Date Fin</label>
								  <input class="form-control me-2" type="date" value="{{today|date:'Y-m-d'}}" name="date_fin" >
								  
								</div>
								  <!-- <button class="btn btn-outline-primary"  onclick="fetchOperationsPercentage()">Actualiser</button> -->
							  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
								<span class="navbar-toggler-icon"></span>
							  </button>
							  <div class="collapse navbar-collapse" id="navbarSupportedContent">
								
								
									
									
								
							  </div>
							</div>
						  </nav>
					</div>
				  </div>
			<div class=" p-4 d-flex flex-wrap justify-content-between">
				<div class="col-md-3 col-6 p-2">
					<a href="/evaluer/0/" class="text-center text-primary">
						<div><i class="fas fa-flag fa-3x"></i></div>
						<div><small>Objectifs et Indicateurs</small></div>
					</a>
				</div>
				<div class="col-md-3 col-6 p-2">
					<a href="/chaine_indicateurs/" class="d-block text-center text-primary">
						<div><i class="fas fa-globe fa-3x"></i></div>
						<div><small>Chaine de Resultats</small></div>
					</a>
				</div>
				<div class="col-md-3 col-6 p-2">
					<a href="/gestionnaire/0/" class="d-block text-center text-primary">
						<div><i class="fas fa-table fa-3x"></i></div>
						<div><small>Gestionnaire {{type_entity}}</small></div>
					</a>
				</div>
				<div class="col-md-3 col-6 p-2">
					<a href="/personnels/" class="text-center text-primary">
						<div><i class="fas fa-users fa-3x"></i></div>
						<div><small>Ressources Humaines</small></div>
					</a>
				</div>
				<div class="accordion accordion-header-primary " id="accordionStyle1">
					<div class="accordion-item">
					  <h2 class="accordion-header">
						<button
						  type="button"
						  class="accordion-button collapsed btn btn-dark"
						  data-bs-toggle="collapse"
						  data-bs-target="#accordionStyle1-1"
						  aria-expanded="false">
						 Planification Par P&eacute;riode 
						</button>
					  </h2>
				  
					  
					</div>
				  
					</div>
			</div>
		</div>
	</div>
</div>



	{% endif %}

	{% if permissions > 0 or entity_manage != None %}
	<div class="technic_section all_section">
		<div class="h5 title_div" style="width:99%;border-bottom:1px solid #aaa;color:#aaa;"> Performance Technique</div>
		<div style="width:100%;" class=" py-3 col-lg-12 d-flex flex-wrap justify-content-between">
			<div class="col-lg-5 col-12">
				<canvas style="width:100%;" id="indi_chart"> </canvas>
			</div>
			<div class="col-lg-7 col-12">
				<canvas style="width:100%;min-height:270px;" id="indi_chart2"></canvas>
			</div>
		</div>
	</div>
	{% endif %}

</div>

{% if finan_options != None %}
{% if permissions > 0 or entity_manage != None %}
<div class="budget_section all_section">
	<div class="h5 title_div" id="title2" style="width:99%;border-bottom:1Px solid #aaa;color:#aaa;"> Execution Budget </div>
	<div style="width:100%;" class=" py-3 col-lg-12 d-flex flex-wrap">
		<div class="col-lg-6">
			<canvas style="width:100%;max-height:270px;" id="budget_chart"> </canvas>
		</div>
		<div class="col-lg-6">
			<canvas style="width:100%;max-height:270px;" id="budget_chart2"> </canvas>
		</div>
	</div>
</div>
{% endif %}
{% endif %}
<div class="col-md-12">
	<div class="card">
	  <div class="row">
		<div class="col-md-6 col-12">
		 
		  <div class="card-body">
			<div class="d-flex mb-4 align-items-center">
			  <div class="flex-shrink-0">
				<div id="contains"></div>


			  </div>
			</div>
			
		  </div>
		</div>
		<div class="col-md-6 col-12">
		 
		  <div class="card-body">
			
			<div class="d-flex mb-4 align-items-center">
			  <div class="flex-shrink-0">
				<div id="chartContainer" style="height: 350px; width: 110%;"></div>
			
			  </div>
			
			</div>
		  </div>
		</div>

		

	  </div>
	</div>
  </div>
 <div class="col-md-12">
	<div class="accordion" id="accordionWithIcon">
		<div class="accordion-item ">
		  <h2 class="accordion-header d-flex align-items-center">
			<button
			  type="button"
			  class="accordion-button bg-dark text-light"
			  data-bs-toggle="collapse"
			  data-bs-target="#accordionWithIcon-1"
			  aria-expanded="true">
			  <i class="icon-base bx bx-bar-chart-alt-2 me-2"></i>
			Chaine de resultat
			</button>
		  </h2>
	  
		  <div id="accordionWithIcon-1" class="accordion-collapse collapse hide">
			<div class="accordion-body">
			  
				
					<div id="myDiagramDiv" style="font-family:Ubuntu;background-color: rgb(242, 242, 242); width: 100%; height: 200px; position: relative; -webkit-tap-highlight-color: rgba(255, 255, 255, 0); cursor: auto;"><canvas tabindex="0" width="1229" height="681" style="position: absolute; top: 0px; left: 0px; z-index: 2; user-select: none; touch-action: none; width: 1229px; height: 681px; cursor: auto;">This text is displayed if your browser does not support the Canvas HTML element.</canvas><div style="position: absolute; overflow: auto; width: 1246px; height: 698px; z-index: 1;"><div style="position: absolute; width: 1621.95px; height: 778.214px;"></div></div></div> 
			  
					<div id="localDiagram"  style="margin-top:30px;font-family:Ubuntu;background-color: rgb(242, 242, 242); width: 100%; height: 500px; position: relative;"> </div> -->
	
			</div>
		  </div>
		</div>
	  
		
		
	  </div>
	
				<!-- <h5 style="font-weight: bold;">Chaine de resultat</h5>
			</div>
			<div id="sample" style="font-family:Ubuntu;width:100%;position: relative;">
				<div id="myDiagramDiv" style="font-family:Ubuntu;background-color: rgb(242, 242, 242); width: 100%; height: 200px; position: relative; -webkit-tap-highlight-color: rgba(255, 255, 255, 0); cursor: auto;"><canvas tabindex="0" width="1229" height="681" style="position: absolute; top: 0px; left: 0px; z-index: 2; user-select: none; touch-action: none; width: 1229px; height: 681px; cursor: auto;">This text is displayed if your browser does not support the Canvas HTML element.</canvas><div style="position: absolute; overflow: auto; width: 1246px; height: 698px; z-index: 1;"><div style="position: absolute; width: 1621.95px; height: 778.214px;"></div></div></div> 
		  
				<div id="localDiagram"  style="margin-top:30px;font-family:Ubuntu;background-color: rgb(242, 242, 242); width: 100%; height: 500px; position: relative;"> </div> -->
</div>
		  
	

  


<div class="h5 title_div"  id="title2" style="width:99%;border-bottom:1Px solid #aaa;color:#aaa;"> Gestionnaire {{type_entity}}</div>
<div  style="width:100%;" class=" py-3 col-lg-12 d-flex flex-wrap">
	<div id="myChartpro_block2" style="display:none;" class="col-lg-12 flex-wrap d-none"></div>
	<div style="width:100%;"  class="col-lg-12 d-flex flex-wrap">
		{% for entity in pages_o %}
		<div class=" mb-3 d-flex flex-wrap justify-content-center col-lg-12" style="">
			<a class="d-block col-lg-4 col-md-6 col-sm-12" href="/gestionnaire/0/{{entity.entity.id}}">

				<div class="col-12">
					<center><img style="max-width:250px;height:220px;" src="{% if entity.entity.m_type_entity.is_pic_represented %} {% if entity.entity.m_pic_represented.url != None %}{{entity.entity.m_pic_represented.url}} {% else %} {{actual_institution.img.url}} {% endif %}{% else %} {{actual_institution.img.url}} {% endif  %}" class="card-img-top" alt="..."></center>
					<div class="card-body">
						<p class="col-lg-12 card-text p-0 m-0">
							<div class="pt-2 text-center h4">{{entity.entity.get_name}}
							</div>

							<div class="d-flex justify-content-center">
								<div class="progress_launcher" data-id="{{entity.entity.id}}"></div>
									<!--
									<div class="technic_launcher" data-id="{{entity.entity.id}}"><span class="badge badge-warning">T:</span></div>
									<div class="financial_launcher" data-id="{{entity.entity.id}}"><span class="badge badge-success">F:</span></div> -->
								</div>
							</p>
						</div>
					</div>
				</a>
				{% block programm_content %}

				<div class="col-lg-8 col-md-6 col-sm-12 mb-3 card py-3" style="max-height:365px;overflow:auto;background:#fff;border:none;">
					<div class="entityDIV" style="border:none;">
						{% if type_entity.is_tache %}
						{% for tache in entity.values %}
						<div>
							<div style="border-bottom:2px dotted #777;" class=" pt-4">
								<div> <b>{{tache}}</b> </div>
								<div class="progress_launcher" data-id="{{entity.entity.id}}">

								</div>
								<div class="d-flex justify-content-around">
									<div class="progress_launcher" data-id="{{sub.id}}"></div>

								</div>
							</div>

							<div><small> Mis Ã  Jour le {{tache.m_date_modif}}</small></div>
							<div class=" json_ope">
								{% for operation in tache.sub_entities %}
								{% if request.user.personnel in operation.get_personnel or permissions > 4 %}

								{% if operation.etat == '2' %}
								<a href="/operations/{{operation.id}}/" class="text-success d-flex flex-wrap mt-3 justify-content-between">
									<div class=""> <i class="fas fa-check"></i> {{operation}}</div>
									<div class="progress_launcher" data-id="{{operation.id}}"></div>
								</a>
								{% elif operation.etat == '0' %}
								<a href="/operations/{{operation.id}}/" class="text-danger d-flex flex-wrap mt-3 justify-content-between">
									<div class=""> <i class="fas fa-exclamation-triangle"></i> {{operation}}</div>
									<div class="d-flex justify-content-around">
										<div class="progress_launcher" data-id="{{operation.id}}"></div>
									</div>
								</a>
								{% else %}
								<a href="/operations/{{operation.id}}/" class="text-info d-flex flex-wrap mt-3 justify-content-between">
									<div class=""> <i class="fas fa-clock"></i> {{operation}}</div>
									<div class="progress_launcher" data-id="{{operation.id}}"></div>

									<div class="d-flex justify-content-around">
										<div class="progress_launcher" data-id="{{sub.id}}"></div>

									</div>
								</a>
								{% endif %}
								{% else %}
								<a href="/operations/{{operation.id}}"  class="d-flex flex-wrap mt-3 justify-content-between">
									<div class=""> <i class="fas fa-circlek"></i> {{operation}}</div>
									<div class="progress_launcher" data-id="{{operation.id}}"></div>
									<div>
										<a href="/decision/o/{{operation.id}}/" class="text-secondary"><span>Cette OpÃ©ration ne vous etes pas attribuÃ©e</span></a>
									</div>
								</a>
								{% endif %}
								{% endfor %}
								{% for operation in tache.operations_not_done %}
								{% if operation.personnel != request.user.personnel and permissions < 4 %}
								<div>
									<div class="mt-3">
										<div><small>{{operation}}</small></div>
										<div><small>Cettte OpÃ©ration ne vous est pas attribuÃ©e</small></div>
									</div>
								</div>
								{% endif %}
								{% endfor %}
							</div>
							{% for operation in tache.operations %}
							{% if operation.progression == 100 %}
							<div>
								<div class="text-success mt-3">
									<div><small>{{operation}}</small></div>
									<div><small>Op&eacute;ration termin&eacute; : R. Technique disponible</small></div>
								</div>
							</div>
							{% endif %}
							{% endfor %}
						</div>
						{% endfor %}
						{% else %}
						{% for tache in entity.values %}
						<div>
							<div style="border-bottom:2px dotted #777;" class="justify-content-between pt-4">
								<div> <a href="/gestionnaire/{{nature}}/{{tache.id}}">{{tache}} </a> </div>

							</div>
							{% if tache.progression == 100 and permissions > 1 %} {% if tache.is_rapported == False %}
							<div class='mb-3' style="cursor:pointer;" onclick="loadTaches('a1',this);" data-tache="{{tache.id}}" data-toggle='modal' data-target="#valid_SupLogic"><b class="btn btn-light text-success"> Valider {{entity.entity.get_name}}</b></div>
							{% else %}
							<div class='mb-3' style="cursor:pointer;"><b class="btn"> {{entity}} Valid&eacute;e</b> <a href="/gestionnaire/a1/{{tache.id}}/">Voir le Rapport</a></div>
							{% endif %}{% endif %}
							<div><small> Mis Ã  Jour le {{tache.m_date_modif}}</small></div>
							<div class="json_ope ">
								{% for sub in tache.sub_entities %}

								<div class="mt-3 d-flex flex-wrap justify-content-between">
									<div>
										<a href="/gestionnaire/{{next_nature}}/{{sub.id}}" class="">{{sub}}</a>


									</div>
									<!-- <div class="progress_launcher" data-id="{{sub.id}}"></div> -->
									<div class="d-flex justify-content-around">
										<div class="progress_launcher" data-id="{{sub.id}}"></div>
									<!-- <div class="technic_launcher" data-id="{{sub.id}}"><span class="badge badge-warning"></span></div>
										<div class="financial_launcher" data-id="{{sub.id}}"><span class="badge badge-success"></span></div> -->
									</div>
								</div>
								{% empty %}
								<div>{{type_entity}} non assignÃ©</div>
								{% endfor %}
							</div>
						</div>
						{% endfor %}
						{% endif %}
					</div>
				</div>
				{% endblock %}
			</div>
			{% endfor %}
			{% if nb_top_entity == 0 %}
			{% if permissions > 4 %}
			<div class="">
				<h3 class="card-title text-center"> Vous n'avez encore rien plannifiÃ©</h3>
				<div class="card-body">
					<div class="text-centers"><a href="/gestionnaire/p/" class="btn btn-primary">CrÃ©er un {{top_entity}}</a></div>
				</div>
			</div>
			{% else %}
			<div class="">
				<h3 class="card-title text-center"> Vous n'etes impliquÃ© actuellement dans aucun {{top_entity}}</h3>
				<div class="card-body d-flex">
					<div class="text-centers"><a href="/gestionnaire/p/" class="btn btn-success">Contacter la Hierachie</a></div>
					<div>&nbsp;&nbsp;</div>
					<div class="text-centers"><a href="/gestionnaire/p/" class="btn btn-warning">Contacter Opera +</a></div>
				</div>
			</div>
			{% endif %}
			{% endif %}
		</div>

	</div>



	{% if num_pages > 0 %}
	<nav style="text-align: center;">
	<ul class="pagination justify-content-center">
		<li>
			{% if pages.number > 1 %}
			<a href="?page={{pages_o.previous_page_number}}" aria-label="Previous" class="btn btn-light rounded-circle">&laquo; Prev
			</a>
			{% endif %}
		</li>
		{% for num in page_range %}
		<li><a {% if pages_o.number == num %} class="btn btn-info rounded-circle"  {% else %} class="btn btn-light text-secondary rounded-circle"  {% endif %} href="?page={{num}}">{{num}}</a></li>
		{% endfor %}
		<li>
			{% if pages.number < num_pages %}
			<a href="?page={{pages_o.next_page_number}}" aria-label="Next" class="btn btn-light rounded-circle">
				Next &raquo;
			</a>
			{% endif %}
		</li>
	</ul>
</nav>

	{% if permissions == 0 %}
	<div class="row">
		<div class="col-lg-12">
			<div style="background-image:url({% static 'webpages/datas_background.jpg' %});background-size:cover;width:100%;height:200px;">
				<div style="background:rgba(0,25,150,0.6);width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;">
					<div>
						<h2 class="text-center text-white"> Renseignement des Donnees </h2>
						<div class="text-center"><a href="data_form/-1/0/" class="btn btn-light">Cliquer ici</a></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	<div class="h5 d-none" style="width:99%;border-bottom:1px solid #aaa;color:#aaa;">Participation par {{default_struc_name}}</div>
	<div class="mt-4 row mb-5 px-2 d-none pr-2">
		<div id='chart4DIV' class="col-lg-5 col-12 col-md-6">
			<canvas id='myChart4' style="background:#fff; width:100%;max-width:700px;min-height:50px;"></canvas>
		</div>
		<div class="card col-lg-7 py-2" style="border:none;max-height:100%;overflow-y:auto;">
			<div class="text-center pt-4">
				<label> Repartition des {{last_entity}} par {{default_struc_name}}</label>
			</div>
			<div id='structach_repart'>

			</div>
		</div>
	</div>

	<div class="row mb-5" style="display:none;">
		<div id='chart5DIV' class="col-lg-8 col-12 col-md-6">
			<canvas id='myChart5' style="min-height:250px;width:100%;max-width:900px;"></canvas>
		</div>
		<div class="col-lg-4 card py-2" style="border:none;max-height:100%;overflow-y:auto;">
			<div class="text-center pt-4">
				<label> Ex&eacute;cution - {{last_entity}} par {{default_struc_name}}</label>
			</div>
			<div id='structach_evo'>

			</div>
		</div>
	</div>


	<div style="width:100px;height:40px;" class="">

	</div>
	{% endif %}
</div>
</div>





</div>

</div>
</div>


<div class="modal fade "id="valid_SupLogic" tabindex="-1" role="dialog" aria-hidden="true" >
	<div class="modal-dialog" style="justify-content:flex-start;">
		<div class="modal-content">
			<div class="modal-header">
				<!--button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button-->
				<h4 class="modal-title">Rapport - <span class="h4 text-info attendu-modal"></span></h4>
				<button type="button" class="close waves-effect waves-light" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">Ã—</span>
				</button>
			</div>
			<form method="POST" id='save_valid_rapport' action="/save_valid_rapport/">
				{% csrf_token %}
				<div class="modal-body d-flex justify-content-between">
					<div style="padding-right:10px;">
						<!-- border-right:2px solid #aaa; -->
						<label class="text-center h5"> Objectifs {{type_entity}} </label>
						{% block expected_divs %}
						<div class='attendu-modal'>
						</div>
						{% endblock %}
					</div>
					<div style="padding-left:10px;">
						<label class="text-center h5"> Informations Ã  Rapporter </label>

						<div class='attendu-modal'>

						</div>
					</div>
				</div>
				<input type="hidden" id="resultat_realise" name="resultat_realise" value="">
				<input type="hidden" name="value" id="tache_realisee">
				<input type="hidden" name="nature" value="{{nature}}">
				<input type="hidden" name="institution" value="{{actual_institution.id}}">
				<div class="modal-footer">
					<input type="submit" class="btn btn-success" value="Enregistrer le Rapport" name="">
				</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">

	function launchMainInterface(block){
		blocks = [$("#main_content"),$("#navigation_section")];
		blocks[1-block].slideUp('slow',function(){
			blocks[block].slideDown('slow');
		})
	}

	var year = new Date().getFullYear();
	var month = new Date().getMonth()+1<10?"0"+(new Date().getMonth()+1):new Date().getMonth()+1;
	var day = new Date().getDate()<10?"0"+new Date().getDate():new Date().getDate();
	var date = day +" - "+month+" - "+year;
	function loadActuDate(){
		jours = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
		mois = ["Janvier","Fevrier","Mars","Avril","Mai","Juin","Juillet","Aout","Septembre","Octobre","Novembre","Decembre"]
		var tmp = new Date();
		var tmp_year = tmp.getFullYear();
		var tmp_month = tmp.getMonth();
		var tmp_date = tmp.getDate();
		var tmp_day = tmp.getDay();
		var result = jours[tmp_day]+" "+tmp_date+" "+mois[tmp_month]+" "+tmp_year
		$(".actu_date").text(result);
	}//.getDate()

function currentTime() {
  let date = new Date();
  let hh = date.getHours();
  let mm = date.getMinutes();
  let ss = date.getSeconds();
  let session = "AM";
loadActuDate()

  if(hh > 12){
      session = "PM";
   }

   hh = (hh < 10) ? "0" + hh : hh;
   mm = (mm < 10) ? "0" + mm : mm;
   ss = (ss < 10) ? "0" + ss : ss;

   let time = hh + " H " + mm; //+ ":" + ss + " ";

  document.getElementById("clock").innerText = time;
  let t = setTimeout(function(){ currentTime() }, 1000);

}

currentTime();


		$(".action").click(function(){
			data_id = $(this).attr('data-id')+"actions";
			$("#"+data_id).show('slow');
		});
		function loadTaches(nature='{% if nature != None %} {{nature}} {% else %} 0 {% endif %}',element){
			//alert("ddd")
			data_tache = element.getAttribute('data-tache');
			tache_realisee = document.getElementById("tache_realisee");
			tache_realisee.value = data_tache;
			$.ajax({
				url: '/get_elements/',
				data: {
					'nature':{% if nature != None %} {{nature}} {% else %} 0 {% endif %},
					'value':data_tache,
					'institution':{{actual_institution.id}}
				},
				dataType: 'json',
				success: function (data) {
					attendu = document.getElementsByClassName("attendu-modal");
					attendu[0].textContent = data.entity;
					attendu[1].innerHTML = "";
					attendu[2].innerHTML = "";
					for (var i=0;i<data.default_fields.length;i++){
						attendu[1].innerHTML += "<div class='col-sm-12 mt-3'><div class='form-group'>"+data.default_fields[i];
						if (data.default_fields_type[i] == 'text'){
							attendu[1].innerHTML += "<textarea class='form-control' readonly rows='3'>"+data.default_fields_values[i]+"</textarea>";
						}
						else{
							attendu[1].innerHTML += "<input class='form-control' readonly type='text' value='"+data.default_fields_values[i]+"''>";
						}
						attendu[1].innerHTML += "</div></div>";
					}
					for (var i=0;i<data.expected_fields.length;i++){
						attendu[2].innerHTML += "<div class='col-sm-12 mt-3'><div class='form-group'>"+data.expected_fields[i];
						if (data.expected_types_type[i] == 'text'){
							attendu[2].innerHTML += "<textarea class='form-control expected_value' rows='3'>"+"</textarea>";
						}
						else{
							attendu[2].innerHTML += "<input class='form-control expected_value' type='text' value=''>";
						}
						attendu[2].innerHTML += "</div></div>";
					}
				},
				error: function(data){

				}
			});
		}

		entityDIV = document.getElementsByClassName('entityDIV');
		for (var i=0; i<entityDIV.length; i++){
			json_ope = entityDIV[i].getElementsByClassName('json_ope');
	//alert(json_ope.length);
	if (json_ope.length < 1){
		entityDIV[i].innerHTML += "<div class='pl-2 mt-3 text-secondary'> 0 {{type_entity}} Ã  RÃ©aliser </div>"
	}
}
/*
top_img = document.getElementsByClassName("top_img");

{% if type_entity.is_pic_represented %}
for(var i=0; i<top_img.length; i++){
	top_img[i].setAttribute('src',top_img[i].getAttribute('data-img_name'))
}
{% else %}
topimgs = ["{% static 'webpages/cool_imgs/img1.webp' %}","{% static 'webpages/cool_imgs/img4.jpg' %}","{% static 'webpages/cool_imgs/img3.webp' %}","{% static 'webpages/cool_imgs/img4.jpg' %}","{% static 'webpages/cool_imgs/img5.jpg' %}","{% static 'webpages/cool_imgs/img6.jpg' %}"];
for(var i=0; i<top_img.length; i++){
	top_img[i].setAttribute('src',topimgs[(i%6)])
}
{% endif %}
*/



save_valid_rapport  = document.getElementById('save_valid_rapport');
if (save_valid_rapport != null){
	save_valid_rapport.onsubmit = function(){
		expected_value = document.getElementsByClassName("expected_value");
		resultat_realise = document.getElementById("resultat_realise");
		for (var i=0; i<expected_value.length; i++){
			resultat_realise.value += resultat_realise.value + "|"
		}
	}
}
/*
var opts2 = {
		angle: 0.1,
		lineWidth: 0.44,
		radiusScale: 1,
		pointer:{
			length:0.6,
			strokeWidth: 0.035,
			color:"#000000",
		},
		limitMax: false,
		limitMin: false,
		colorStart: '#00e380',
		colorStop:'#a214d2',
		strokeColor: "#1234a2",
		generateGradient: true,
		highDpiSupport:true,
		staticZones: [
		{strokeStyle: "#ff0030",min:0, max:20},
		{strokeStyle: "#d06910",min:20, max:40},
		{strokeStyle: "orange",min:40, max:60},
		{strokeStyle: "#a0a345",min:60, max:80},
		{strokeStyle: "green",min:80, max:100}
		],
		staticLabels: {
	font: "14px Ubuntu",  // Specifies font
	labels: [0,20,40,65,80,100],  // Print labels at these values
},
}
*/

var targets2 = document.getElementsByClassName("barometer_indic");
var targets3 = document.getElementsByClassName("barometer_budget")
gauges2 = new Array();
gauges3 = new Array();
for (var i=0; i<targets2.length; i++){
	var gauge2 = new Gauge(targets2[i]).setOptions(opts);
	gauge2.maxValue = 100;
	gauge2.setMinValue(0)
	gauge2.animationSpeed = 12;
	gauge2.set(0);
	gauges2.push(gauge2)
}
for (var i=0; i<targets3.length; i++){
	var gauge3 = new Gauge(targets3[i]).setOptions(opts);
	gauge3.maxValue = 100;
	gauge3.setMinValue(0)
	gauge3.animationSpeed = 12;
	gauge3.set(parseInt(0));
	gauges3.push(gauge3)
}
showMainInte(null,0)
</script>

<script type="text/javascript">
	arg_cumul1 = 0;
	arg_cumul2 = 0;

	$("#cumul1").change(function(){
		arg_cumul1=0;
		if (this.checked == true){
			arg_cumul1 = 1;
		}
		actual_periode_last(period_select,arg_cumul1,arg_cumul2)
	});
	$("#cumul2").change(function(){
		arg_cumul2=0;
		if (this.checked == true){
			arg_cumul2 = 1;
		}
		actual_periode_last(period_select,arg_cumul1,arg_cumul2)
	});

	var xValues = ["x1","x2","x3"];
	var barColors = ["green", "#14b593","blue","#759845","#2365a3","#875Sdf","purple","pink","yellow","#a45467","#a2b514"];
	var yValues = [55, 49, 44];
	myChartpro_block = document.getElementById("myChartpro_block");

	{% if True %} // type_entity.is_tache == False
	{% for entity in pages_o %}
	myChartpro_block.innerHTML += "<div class='{% if lvl == -1 %} col-lg-12 {% else %} col-lg-12 {% endif %}canver' style='min-height:320px;'><canvas id='myChartpro{{forloop.counter}}' style='width:100%;'></canvas> </div>";
	{% endfor %}

	{% for entity in pages_o %}
	tasks_names = [{% for v in entity.values %}"{{v}}",{% endfor %}""];
	xValues =[{% for v in entity.values %}
	"{{forloop.counter}}",
	{% endfor %}""];
	yValues = [{% for v in entity.values %}{{v.progression}},{% endfor %}0];
		//alert(xValues)
		new Chart("myChartpro{{forloop.counter}}", {
			type: {% if lvl != -1 %}"bar",{% else %}"bar",{% endif %} //horizontalBar
			data: {
				labels: [""],
				datasets: [{% for v in entity.values %} {
					label: '{{v.get_name}}'.replace('&#x27;',"'"),
					fill:'origin',
					backgroundColor: barColors[({{forloop.counter}}-1)],
					data: [ yValues[({{forloop.counter}}-1)] ]
				},{% endfor %}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					datalabels: {
						color: 'black',
						anchor: "end",
						align: "right",
						offset: 20,
						display: function (context) {
							return context.dataset.data[context.dataIndex];
						},
						font: function(context) {
							var width = 100;
							var size = Math.round(width / 32);

							return {
								weight: 'bold',
								size: size
							};
						},
						formatter: Math.round
					},
					legend: {
						display: true,
						labels: {
							color: 'rgb(255, 99, 132)'
						}
					}
				},
				indexAxis: 'y',
				title: {
					display: true,
					text: "{{entity.entity.get_name}}".replace('&#x27;',"'")
				},
				tooltips: {
					 /*callbacks: {
							title: function(t, d) {
								 return tasks_names[t[0].index];
							}
						}*/
					},
					scales: {
						yAxes: [{
							ticks: {
								beginAtZero: true,
								suggestedMax: 100
							}
						}],
						xAxes: [{
							ticks: {
								beginAtZero: true,
								suggestedMax: 100
							},
							callback: function(t) {
								var maxLabelLength = 3;
								if (t.length > maxLabelLength) return t.substr(0, maxLabelLength) + '...';
								else return t;
							}
						}],
						x: {
							beginAtZero: true
						}
					}
				}
			});
		{% endfor %}
		{% endif %}
	//myChartpro_block.innerHTML += "<div class='card col-lg-3'> SSSD</div>"
	 //alert(myChartpro_block.innerHTML)
	 canver = document.getElementsByClassName("canver");
	 if (canver.length == 0){
	 	myChartpro_block.innerHTML += "<div class='h4 text-info'> DÃ©solÃ©, pour l'Instant il y'a 0 {{type_entity}} <a href='/gestionnaire/{{nature}}/' class='btn btn-info'> Nouveau </a></div>"
	 }

	 var xValues = ["ValidÃ©s","En Attente","RejetÃ©s"];
	 var barColors1 = ["green","orange","red"];
	 var yValues = [10, 4, 5];
	/*new Chart("myChart3", {
		type: "pie",
		data: {
			labels: xValues,
			datasets: [{
				backgroundColor: barColors1,
				data: yValues
			}]
		},
		options: {
			title: {
				display: true,
				text: "Gestion des Rapports "
			}
		}
	});
	*/


/*
if (nb_taches == 0){
	rapport_block = document.getElementById("rapport_block");
	rapport_block.setAttribute('style','display:none;');
}
*/
data_period={{actual_institution.default_period.m_logic_type}};
year_plan = document.getElementById("year_plan");
year_plan.value = new Date().getFullYear();

	/*
	year_plan2 = document.getElementById("year_plan2");
	year_plan2.value = new Date().getFullYear();
	*/

	function launch_dataPeriod(week_fix="week_plus"){
		actual_year = parseInt(year_plan.value);
		week_detail = document.getElementsByClassName('week_detail');
		if (data_period == 2){
			the_weeks = new Array()
			first_day = new Date(actual_year,0,1);
			tmp_shit = first_day.getUTCDay();
			if ( tmp_shit != 0){
				first_day  = new Date((actual_year-1),11,(32-tmp_shit));
				last_day = new Date((actual_year-1),11,6+first_day.getDate());
			}
			else{
				last_day = new Date((actual_year),0,7);
			}
			tmp_i = 0;
			for (var k=0;k<53;k++){
				tmp_first = first_day.getDate()+" "+months[first_day.getMonth()]+" "+first_day.getFullYear()
				tmp_last = last_day.getDate()+" "+months[last_day.getMonth()]+" "+last_day.getFullYear()

				the_weeks.push("Semaine du "+tmp_first+" au "+tmp_last)
				actual_month = last_day.getMonth()
				first_day = new Date(actual_year,actual_month,1+last_day.getDate());
				actual_month = first_day.getMonth()
				last_day = new Date(actual_year,actual_month,6+first_day.getDate());
				tmp_i += 7;
			}
			tmp = "";

			week_card = document.getElementsByClassName("week_card");
			for (var k=0;k<week_card.length;k++){
				//alert(the_weeks[k])
				week_card[k].textContent = the_weeks[k];
			}
			week_plus = document.getElementsByClassName(week_fix);
			for (var k=0;k<week_plus.length;k++){
				//alert(the_weeks[k])
				week_plus[k].textContent = the_weeks[k];
			}
		}
		else if (data_period == 3){

			for (var k=0;k<12;k++){
				first_day = new Date(actual_year,k,0);
				first_day = new Date(actual_year,k,1);
				last_day = new Date(actual_year,(k+1),0);
				tmp_first = first_day.getDate()+" "+months[first_day.getMonth()]+" "+first_day.getFullYear()
				tmp_last = last_day.getDate()+" "+months[last_day.getMonth()]+" "+last_day.getFullYear()

				the_weeks[k] = "du "+tmp_first+" au "+tmp_last
			}
			for (var k=0;k<week_detail.length;k++){
				week_detail[k].innerHTML = the_weeks[k%12]
			}
			week_card = document.getElementsByClassName("week_card");
			for (var k=0;k<week_card.length;k++){
				//alert(the_weeks[k])
				week_card[k].textContent = the_weeks[k];
			}
			week_plus = document.getElementsByClassName(week_fix);
			for (var k=0;k<week_plus.length;k++){
				//alert(the_weeks[k])
				week_plus[k].textContent = the_weeks[k];
			}

		}
		else if (data_period == 6){
			for (var k=0;k<2;k++){
				first_day = new Date(actual_year,k*6,1);
				last_day = new Date(actual_year,6*(k+1),0);
				tmp_first = first_day.getDate()+" "+months[first_day.getMonth()]+" "+first_day.getFullYear()
				tmp_last = last_day.getDate()+" "+months[last_day.getMonth()]+" "+last_day.getFullYear()

				the_weeks[k] = "du "+tmp_first+" au "+tmp_last
			}
			for (var k=0;k<week_detail.length;k++){
				week_detail[k].innerHTML = the_weeks[k%4]
			}
		}
		else if (data_period == 9){
			for (var k=0;k<4;k++){
				first_day = new Date(actual_year,k*3,1);
				last_day = new Date(actual_year,3*(k+1),0);
				tmp_first = first_day.getDate()+" "+months[first_day.getMonth()]+" "+first_day.getFullYear()
				tmp_last = last_day.getDate()+" "+months[last_day.getMonth()]+" "+last_day.getFullYear()

				the_weeks[k] = "du "+tmp_first+" au "+tmp_last
			}
			for (var k=0;k<week_detail.length;k++){

				week_detail[k].innerHTML = the_weeks[k%4]
			}
		}
	}

	launch_dataPeriod();
	launch_dataPeriod("week_detail2");
	launch_dataPeriod('week_plus3')
	last_semaine = document.getElementById("last_semaine")
	year_plan.onchange = function(){
		launch_dataPeriod();
		actual_periode_last(document.getElementById("period_select"));

		launch_dataPeriod("week_detail2");
	}

	period_select = document.getElementById("period_select");
	last_semaine.textContent = period_select.getElementsByTagName("option")[(period_select.value)].textContent;

	function actual_periode_last(div="#",cumul1=arg_cumul1,cumul2=arg_cumul2){//cumul 1 for the cumulation, cumul 2 for the actual periods
		year = year_plan.value;
		if (div == "#"){
			d_value = this.value;
		}
		else{
			d_value = div.value;
		}
		if (d_value != 0 ){
			tmp = new Date(year,0,1);
			f_t =  - tmp.getUTCDay();
			f_day = tmp.getUTCDay();
			if (data_period == 2){
				tmp2_1 = ""+new Date(year,0,tmp.getDate()-f_day+ (7*(d_value-1)) );
				tmp2_2 = ""+new Date(year,0,tmp.getDate()-f_day+6+ (7*(d_value-1)) );
				tmp_word = "Semaine du "
			}
			else if(data_period == 3){
				tmp_year = d_value
				tmp2_1 = ""+new Date(year,(d_value-1),1);
				tmp2_2 = ""+new Date(year,(d_value),0);
				tmp_word = "Du "
			}
			else if(data_period == 6){

			}

			m1 = tmp2_1.split(" ");
			m2 = tmp2_2.split(" ");
			msg = tmp_word+m1[2] +" "+m1[1] +" "+m1[3]+" au "+m2[2]+" "+ m2[1]+" " + m2[3]
			last_semaine.textContent = msg;
			$.ajax({
				url: '/ajax_progress/',
				data:{
					'periode':{{actual_institution.default_period.id}},
					'plannify': msg,
					'institution':{{actual_institution.id}},
					'year': year,
					'cumul1':cumul1,
					'cumul2':cumul2
				},
				dataType: 'json',
				success: function(data){
					var targets = document.getElementsByClassName("barometer");
					for (var i=0; i<targets.length; i++){
						gauges[i].set(parseInt(data.progression));
					}
					$(".progr_btn").text(data.progression+" %")
				}
			});
		}
		else{
			var targets = document.getElementsByClassName("barometer");
			for (var i=0; i<targets.length; i++){
				gauges[i].set(parseInt({{actual_progression}}));
			}
			$(".progr_btn").text("Toutes les Periodes")
		}
	}

	$.ajax({
		url: '/count_indic/',
		data:{
			'institution':{{actual_institution.id}},
			'actual_year':new Date().getFullYear()
		},
		dataType: 'json',
		success: function(data){
			ind_faibles = 0;
			ind_forts = 0;
			for (var i=0;i<data.cibles.length;i++){
				console.log(data.cibles[i] + " - val "+data.indicateurs_values[i] )
				if (data.indicateurs_values[i]<data.cibles[i]){
					ind_faibles += 1;
				}
				else{
					ind_forts +=1
				}
			}
			new Chart("indi_chart", {
				type:"pie",
				data: {
					labels: ["Indicateurs non acheves", "Indicateurs dont la cible a ete atteinte"],
					datasets: [{
						label: 'Atteinte des Objectifs',
						data: [ind_faibles,ind_forts],
						backgroundColor:["red","green"]
					}]
				},
				options: {
					plugins: {
						legend: {
							display: false
						}
					}
				}
			})
			if (data.nb_renseignes == 0){
				$(".indi_renseignes").text(0)
				$(".indi_faibles").text(0)
				$(".indi_forts").text(0)
			}
			else{
				if (data.all > 0){
				$(".indi_renseignes").text((data.nb_renseignes/data.all)*100)
				}
				if (data.nb_renseignes > 0){
					$(".indi_faibles").text((ind_faibles/data.nb_renseignes)*100)
					gauge2.set(parseInt((ind_forts/data.nb_renseignes)*100));
					$(".indi_forts").text((ind_forts/data.nb_renseignes)*100)
				}
				else{
				$(".indi_faibles").text(0)
				gauge2.set(0);
				$(".indi_forts").text(0)
				}
			}
		}
	});
	$.ajax({
		url: '/count_indic/',
		data:{
			'institution':{{actual_institution.id}},
			'actual_year':new Date().getFullYear(),
			{% if actual_institution.top_entity != None %}
			'entity_type':{{actual_institution.top_entity.id}},
			'entity_id':0,
			'type_indic':'T'
			{% endif %}
		},
		dataType: 'json',
		success: function(data){
			barColors = ["green","red"]
			x_labels = ["indicateurs - cibles atteintes","indicateurs - non acheves"]
			x_axes = new Array()
			data_tmps = [data.list_ens_good,data.list_ens_bad]
			//alert(data_tmps)
			for (var x=0; x<2; x++){
				the_tmp = new Array()
				for (var y=0; y<data.entities.length; y++){
					the_tmp.push(parseInt(data_tmps[x][y]))
				}
				x_axes[x]={
					label: x_labels[x],
					backgroundColor: barColors[x],
					data: the_tmp
				}
			}
			new Chart("indi_chart2", {
				type: "bar",
				data: {
					 // labels:data.entities, //["Damn","Desdsd","DWWWWW"], //Sous-entitÃ©
					 labels:data.entities,
					 datasets: x_axes
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						barValueSpacing : 20,
						plugins: {
							legend: {
								display: true,
								labels: {
									color: 'rgb(255, 99, 132)'
								}
							}
						},
						indexAxis: 'y',
						scales: {
							yAxes: [{
								ticks: {
									beginAtZero: true
								}
							}],
							xAxes: [{
								ticks: {
									beginAtZero: true,
									display: false
								},
								callback: function(t) {
									var maxLabelLength = 3;
									if (t.length > maxLabelLength) return t.substr(0, maxLabelLength) + '...';
									else return t;
								}
							}],
							x: {
								beginAtZero: true
							}
						},
						tooltips: {
						 /*callbacks: {
							title: function(t, d) {
							   return tasks_names[t[0].index];
							}
						}*/
					}
				},
			});
		}
	});

	period_select.onchange = function(){
		$(".progr_btn").text("Calcul de la Progression en cours...")
		{% if actual_institution.default_period.default_period.m_logic_type == 3 %}
		actual_periode_last(this);
		{% endif %}
	}
	{% if actual_institution.default_period.default_period.m_logic_type == 3 %}
	actual_periode_last(period_select);
	{% endif %}

	//period_select.change()

	
	

	function loadCH6(mods="0"){
		options_select = period_select.getElementsByTagName("option");
		//alert(options_select)
		datas = "";
		for (var i=0;i<options_select.length;i++){
			d_value = options_select[i].value;
			if (d_value != 0){
				tmp = new Date(year,0,1);
				f_t =  - tmp.getUTCDay();
				f_day = tmp.getUTCDay();
				tmp2_1 = ""+new Date(year,0,tmp.getDate()-f_day+ (7*(d_value-1)) );
				tmp2_2 = ""+new Date(year,0,tmp.getDate()-f_day+6+ (7*(d_value-1)) );
				m1 = tmp2_1.split(" ");
				m2 = tmp2_2.split(" ");
				msg = "Semaine du "+m1[2] +" "+m1[1] +" "+m1[3]+" au "+m2[2]+" "+ m2[1]+" " + m2[3];
				datas += msg+"#"
			}
		}
		$("#myChart6").html("")
		$("#myChart62").html("")
		$.ajax({
			url: '/ajax_progress/',
			data:{
				'periode':{{actual_institution.default_period.id}},
				'plannify': "#",
				'plannify_all':datas,
				'institution':{{actual_institution.id}},
				'year': year,
				"mods":mods
			},
			dataType: 'json',
			success: function(data){
				prds = new Array();
				for (var i=0; i<data.progressions.length; i++){
					prds.push(data.progressions[i].split("#"))
				}
				console.log(prds)
				chartie_6(prds,parseInt(mods))
			},
			error: function(data){
				console.log("Problem")
			}

		});

	}
	loadCH6();
	$(".default_prPre").change(function(){
		loadCH6(""+this.value)
		//alert(this.value)
	});
</script>


<script>  
    // Obtenir le contexte du graphique  
	var chrt = document.getElementById("chart").getContext("2d");  
	  
	// Initialiser le graphique  
	var chartId = new Chart(chrt, {  
	   type: 'doughnut',  
	   data: {  
		  labels: ["Non Effectuées", "Validées", "Archivées", "En Attente"],  
		  datasets: [{  
			 label: "Sujets de tutoriels en ligne",  
			 data: [9, 13, 35, 40],  
			 backgroundColor: ['yellow', 'pink', 'lightgreen', 'blue'],  
			 hoverOffset: 10  
		  }],  
	   },  
	   options: {  
		  responsive: false,  
		  plugins: {  
			 title: {  
				display: true,  
				text: 'Évolution des Opérations',  
				fontSize: 24,  
				fontColor: '#333333'  
			 },  
			 legend: {  
				position: 'bottom',  
				labels: {  
				   fontColor: '#333333',  
				   fontSize: 14,  
				   boxWidth: 12,  
				   padding: 20  
				}  
			 }  
		  }  
	   }  
	});  

	// Requête AJAX pour obtenir le nombre d'opérations non effectuées  
	$.ajax({  
	   url: '/count_operations/',  
	   method: 'GET',  
	   success: function(response) {  
		  var nonEffectuees = response.count;  
		  console.log("Nombre d'opérations non effectuées : " + nonEffectuees);  
		  // Mettre à jour le graphique avec le nombre d'opérations non effectuées  
		  chartId.data.datasets[0].data[0] = nonEffectuees;  
		  chartId.update();  
	   },  
	   error: function(error) {  
		  console.log(error);  
	   }  
	});  

	// Requête AJAX pour obtenir le nombre d'opérations validées  
	$.ajax({  
	   url: '/count_persos/',  
	   method: 'GET',  
	   success: function(response) {  
		  var valide = response.count_persos;  
		  console.log("Nombre d'opérations validées : " + valide);  
		  // Mettre à jour le graphique avec le nombre d'opérations validées  
		  chartId.data.datasets[0].data[1] = valide;  
		  chartId.update();  
	   },  
	   error: function(error) {  
		  console.log(error);  
	   }  
	});  

	// Requête AJAX pour obtenir le nombre d'opérations archivées  
	$.ajax({  
	   url: '/count_restored/',  
	   method: 'GET',  
	   success: function(response) {  
		  var archive = response.count_restore;  
		  console.log("Nombre d'opérations archivées : " + archive);  
		  // Mettre à jour le graphique avec le nombre d'opérations archivées  
		  chartId.data.datasets[0].data[2] = archive;  
		  chartId.update();  
	   },  
	   error: function(error) {  
		  console.log(error);  
	   }  
	});  

    // Requête AJAX pour obtenir le nombre d'opérations en attente  
	$.ajax({  
		url: '/count_attente_operation/',  
		method: 'GET',  
		success: function(response) {  
		   var attente = response.attente;  
		   console.log("Nombre d'opérations en attente : " + attente);  
		   // Mettre à jour le graphique avec le nombre d'opérations en attente  
		   chartId.data.datasets[0].data[3] = attente;  
		   chartId.update();  
		},  
		error: function(error) {  
		   console.log(error);  
		}  
	});  
</script>


<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/dumbbell.js"></script>
<script src="https://code.highcharts.com/modules/lollipop.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script>
	// window.onload = function() {
	// 	var chart = new CanvasJS.Chart("chartContainer", {
	// 	  exportEnabled: true,
	// 	  animationEnabled: true,
	// 	  title: {
	// 		text: "Statistiques Des Operations Par Nature"
	// 	  },
	// 	  legend: {
	// 		cursor: "pointer",
	// 		itemclick: explodePie
	// 	  },
	// 	  data: [
	// 		{
	// 		  type: "pie",
	// 		  showInLegend: true,
	// 		  toolTipContent: "{name}: <strong>{y}</strong>",
	// 		  indexLabel: "{name} - {y}",
	// 		  dataPoints: []
	// 		}
	// 	  ]
	// 	});

	// 	function getOperationData() {
	// 	  $.ajax({
	// 		url: '/api_count_operations_by_nature/',
	// 		type: 'GET',
	// 		success: function(data) {
	// 		  var dataPoints = [];
	// 		  for (var key in data) {
	// 			dataPoints.push({ y: data[key], name: key });
	// 		  }
	  
	// 		  // Mettre à jour les données du graphique
	// 		  chart.options.data[0].dataPoints = dataPoints;
	// 		  chart.render();
	  
	// 		  console.log("Données récupérées : ", data);
	// 		},
	// 		error: function(error) {
	// 		  console.error('Une erreur s\'est produite :', error);
	// 		}
	// 	  });
	// 	}
	  
		
	// 	getOperationData();
	  
		
	// 	function explodePie(e) {
	// 	  if (typeof (e.dataSeries.dataPoints[e.dataPointIndex].exploded) === "undefined" || !e.dataSeries.dataPoints[e.dataPointIndex].exploded) {
	// 		e.dataSeries.dataPoints[e.dataPointIndex].exploded = true;
	// 	  } else {
	// 		e.dataSeries.dataPoints[e.dataPointIndex].exploded = false;
	// 	  }
	// 	  e.chart.render();
	// 	}
	//   };
	  // Data retrieved from https://olympics.com/en/olympic-games/beijing-2022/medals
// Initialisation du graphique Highcharts
Highcharts.chart('chartContainer', {
    chart: {
        type: 'pie',
        options3d: {
            enabled: true,
            alpha: 45
        }
    },
    title: {
        text: 'Operations Par Nature'
    },
    subtitle: {
        text: '3D Donut in Highcharts'
    },
    plotOptions: {
        pie: {
            innerSize: 100,
            depth: 45
        }
    },
    series: [{
        name: 'Medals',
        data: [] // Initialiser le tableau de données vide
    }]
});

// Fonction pour récupérer les données des opérations
function getOperationData() {
    $.ajax({
        url: '/api_count_operations_by_nature/',
        type: 'GET',
        success: function(data) {
            var dataPoints = [];
            for (var key in data) {
                dataPoints.push({ y: data[key], name: key });
            }

            // Mettre à jour les données du graphique
            var chart = Highcharts.charts[0]; // Récupérer le premier graphique Highcharts
            chart.series[0].setData(dataPoints); // Mettre à jour les données de la série
            chart.redraw(); // Redessiner le graphique

            console.log("Données récupérées : ", data);
        },
        error: function(error) {
            console.error('Une erreur s\'est produite :', error);
        }
    });
}

// Appeler la fonction pour récupérer les données
getOperationData();

</script>

<!-- 

<script>
	Highcharts.chart('contains', {
		chart: {
			type: 'lollipop',
			inverted: true
		},
		legend: {
			enabled: false
		},
		subtitle: {
			text: 'version 4.4'
		},
		title: {
			text: 'Statistique des Operations par Categorie'
		},
		tooltip: {
			shared: true
		},
		xAxis: {
			type: 'category'
		},
		yAxis: {
			title: {
				text: 'Nombre d\'opérations'
			}
		},
		series: [{
			name: 'Nombre d\'opérations',
			data: $.ajax({
				url: '/api_count_operations_by_categorie/',
				method: 'GET',
				dataType: 'json',
				async: false
			}).responseJSON
		}]
	});

	</script> -->
	<script>  
		var categories = $.ajax({  
			url: '/api_get_categories/',  
			method: 'GET',  
			dataType: 'json',  
			async: false  
		}).responseJSON;  
	
		Highcharts.chart('contains', {  
			chart: { type: 'column' },  
			title: { text: 'Statistique Des Categories Par Operation ' },  
			subtitle: { text: 'Source: <a target="_blank" href="/">v4.4</a>' },  
			xAxis: {  
				categories: categories,  
				crosshair: true,  
				accessibility: { description: 'Categories' }  
			},  
			yAxis: {  
				min: 0,  
				title: { text: 'Nombre De Categorie Par Operation' }  
			},  
			tooltip: { valueSuffix: '' },  
			plotOptions: {  
				column: { pointPadding: 0.2, borderWidth: 0 }  
			},  
			series: [  
				{  
					name: 'Nombre d\'opérations par catégorie',  
					data: $.ajax({  
						url: '/api_count_operations_by_categorie/',  
						method: 'GET',  
						dataType: 'json',  
						async: false  
					}).responseJSON  
				},  
				{  
					name: 'Nombre  d\'opérations Valide',  
					data: $.ajax({  
						url: '/api_count_operations/',  
						method: 'GET',  
						dataType: 'json',  
						async: false  
					}).responseJSON  
				}  
			]  
		});  
	</script>
	
	<!-- Resources -->
	<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
	<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
	<script>
		am5.ready(function() {
			// Créer l'élément racine
			var root = am5.Root.new("chartdiv");
	
			// Définir les thèmes
			root.setThemes([
				am5themes_Animated.new(root)
			]);
	
			// Créer le graphique radar
			var chart = root.container.children.push(am5radar.RadarChart.new(root, {
				panX: false,
				panY: false,
				startAngle: 160,
				endAngle: 380
			}));
	
			// Créer l'axe et son rendu
			var axisRenderer = am5radar.AxisRendererCircular.new(root, {
				innerRadius: -60
			});
	
			axisRenderer.grid.template.setAll({
				stroke: root.interfaceColors.get("background"),
				visible: true,
				strokeOpacity: 0.8
			});
	
			var xAxis = chart.xAxes.push(am5xy.ValueAxis.new(root, {
				maxDeviation: 0,
				min: 0,
				max: 100,
				strictMinMax: true,
				renderer: axisRenderer
			}));
	
			var axisDataItem = xAxis.makeDataItem({});
			var clockHand = am5radar.ClockHand.new(root, {
				pinRadius: am5.percent(20),
				radius: am5.percent(100),
				bottomWidth: 40
			});
	
			var bullet = axisDataItem.set("bullet", am5xy.AxisBullet.new(root, {
				sprite: clockHand
			}));
	
			xAxis.createAxisRange(axisDataItem);
	
			var label = chart.radarContainer.children.push(am5.Label.new(root, {
				fill: am5.color(0xffffff),
				centerX: am5.percent(50),
				textAlign: "center",
				centerY: am5.percent(50),
				fontSize: "3em"
			}));
	
			// Initial value
			axisDataItem.set("value", 0);
	
			bullet.get("sprite").on("rotation", function () {
				var value = axisDataItem.get("value");
				var fill = am5.color(0x000000);
				
				xAxis.axisRanges.each(function (axisRange) {
					if (value >= axisRange.get("value") && value <= axisRange.get("endValue")) {
						fill = axisRange.get("axisFill").get("fill");
					}
				});
	
				label.set("text", Math.round(value).toString());
	
				clockHand.pin.animate({ key: "fill", to: fill, duration: 500, easing: am5.ease.out(am5.ease.cubic) });
				clockHand.hand.animate({ key: "fill", to: fill, duration: 500, easing: am5.ease.out(am5.ease.cubic) });
			});
	
			// Fetch operations percentage from the server
			// Fetch operations percentage from the server  
function fetchOperationsPercentage() {  
    const dateDebut = document.querySelector('input[name="date_debut"]').value;  
    const dateFin = document.querySelector('input[name="date_fin"]').value;  
	const date_f = document.getElementById("date_f");
	
	const date_d = document.getElementById("date_d");
	const progressions = document.getElementById("progressions");
	
	date_f.textContent=dateFin;
	date_d.textContent=dateDebut;
    $.ajax({  
        url: '/calculators_operations/', // Update with the correct URL  
        type: 'POST', // Change to POST since you're sending data  
        data: {  
            date_debut: dateDebut,  
            date_fin: dateFin,  
            csrfmiddlewaretoken: '{{ csrf_token }}' // Include CSRF token for security  
        },  
        dataType: 'json',  
        success: function(data) {  
            var operationsPercentage = data.operations_percentage;  
			progressions.textContent=operationsPercentage+"%";
			// console.log(operationsPercentage);
            axisDataItem.animate({  
                key: "value",  
                to: operationsPercentage,  
                duration: 500,  
                easing: am5.ease.out(am5.ease.cubic)  
            });  
        },  
        error: function(xhr, status, error) {  
            console.error('Error fetching data:', error);  
        }  
    });  
	
	
}  

// Call the function every 2 seconds to fetch the updated data  
setInterval(fetchOperationsPercentage, 2000);
	
			// Créer les plages d'axes
			var bandsData = [
				{ title: "Critique", color: "#ee1f25", lowScore: 0, highScore: 20 },
				{ title: "Faible", color: "#f04922", lowScore: 20, highScore: 40 },
				{ title: "Moyen", color: "#fdae19", lowScore: 40, highScore: 60 },
				{ title: "Bon", color: "#f3eb0c", lowScore: 60, highScore: 80 },
				{ title: "Excellent", color: "#b0d136", lowScore: 80, highScore: 100 }
			];
	
			am5.array.each(bandsData, function (data) {
				var axisRange = xAxis.createAxisRange(xAxis.makeDataItem({}));
				axisRange.setAll({
					value: data.lowScore,
					endValue: data.highScore
				});
	
				axisRange.get("axisFill").setAll({
					visible: true,
					fill: am5.color(data.color),
					fillOpacity: 0.8
				});
	
				axisRange.get("label").setAll({
					text: data.title,
					inside: true,
					radius: 15,
					fontSize: "0.9em",
					fill: root.interfaceColors.get("background")
				});
			});
	
			// Animation à l'ouverture
			chart.appear(1000, 100);
		}); // Fin de am5.ready()
	</script>










<script src="https://unpkg.com/gojs@2.2.14/release/go.js"></script>
<script id="code">
  ImgBlock = document.getElementById("ImgBlock");
  var img_absol;
function init() {

  // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
  // For details, see https://gojs.net/latest/intro/buildingObjects.html
  const $ = go.GraphObject.make;  // for conciseness in defining templates

function nodeClicked(e, obj) {  // executed by click and doubleclick handlers
  /*var evt = e.copy();
  var node = obj.part;
  var type = evt.clickCount === 2 ? "Double-Clicked: " : "Clicked: ";
  var msg = type + node.data.key + ". ";
  */
  var evt = e.copy();

  //ocument.getElementById("myStatus").textContent = msg;
}

  myFullDiagram =
	$(go.Diagram, "myDiagramDiv",  // each diagram refers to its DIV HTML element by id
	  {
		initialAutoScale: go.Diagram.UniformToFill,  // automatically scale down to show whole tree
		maxScale: 0.3,
		allowZoom:true,
		contentAlignment: go.Spot.Center,  // center the tree in the viewport
		isReadOnly: true,  // don't allow user to change the diagram
		"animationManager.isEnabled": false,
		layout: $(go.TreeLayout,
		  { angle: 90, sorting: go.TreeLayout.SortingAscending }),
		maxSelectionCount: 1,  // only one node may be selected at a time in each diagram
		// when the selection changes, update the myLocalDiagram view
		"ChangedSelection": showLocalOnFullClick
	  });

  myLocalDiagram =  // this is very similar to the full Diagram
	$(go.Diagram, "localDiagram",
	  {
		autoScale: go.Diagram.UniformToFill,
		contentAlignment: go.Spot.Center,
		isReadOnly: true,
		layout: $(go.TreeLayout,
		  { angle: 90, sorting: go.TreeLayout.SortingAscending }),
		"LayoutCompleted": e => {
		  var sel = e.diagram.selection.first();
		  if (sel !== null) myLocalDiagram.scrollToRect(sel.actualBounds);
		},
		maxSelectionCount: 1,
		// when the selection changes, update the contents of the myLocalDiagram
		"ChangedSelection": showLocalOnLocalClick
	  });

  // Define a node template that is shared by both diagrams
var myNodeTemplate2 =
	$(go.Node, "Auto",
	  {maxSize: new go.Size(260, 50) },
	  { locationSpot: go.Spot.Center },
	  new go.Binding("text", "key", go.Binding.toString),  // for sorting
	  $(go.Shape, "RoundedRectangle",
		new go.Binding("fill", "color"),
		{ stroke: null }),
	  /*$(go.TextBlock,
		{ margin: 5 },
		new go.Binding("text", "name", k => k)),*/
$(go.Panel, "Vertical",
{ position: new go.Point(0, 0)},
$(go.TextBlock, { margin: 5 }, new go.Binding("text", "name", k => k), { font: "12px Ubuntu", stroke: "white" }),
$(go.TextBlock,  new go.Binding("text", "objectif", k => k), { alignment: go.Spot.Center }, { font: "15px Ubuntu", stroke: "white" }),
));

  var myNodeTemplate =
	$(go.Node, "Auto",
	  { 
	   //click: nodeClicked,
	  locationSpot: go.Spot.Center },
	  new go.Binding("text", "key", go.Binding.toString),  // for sorting
	  $(go.Shape, "RoundedRectangle",
		new go.Binding("fill", "color"),
		{ stroke: null }),
	  /*$(go.TextBlock,
		{ margin: 5 },
		new go.Binding("text", "name", k => k)),*/
$(go.Panel, "Vertical",
{ position: new go.Point(0, 0)},
  {maxSize: new go.Size(260, 250) },
$(go.TextBlock, { margin: 5 }, new go.Binding("text", "name", k => k), { font: "11px Ubuntu", stroke: "white" }),
$(go.TextBlock,  { margin: 5 }, new go.Binding("text", "objectif", k => k), { alignment: go.Spot.Center }, { font: "18px Ubuntu", stroke: "white" }, {overflow:go.TextBlock.OverflowEllipsis}),
 $(go.TextBlock,  { margin: 5 }, new go.Binding("text", "l", k => ""), { alignment: go.Spot.Center }, { font: "12px Ubuntu", stroke: "white" }),
$(go.TextBlock,  { margin: 5 },  {cursor: "pointer"}, {click: function(e, obj) {alert  (new go.Binding("text", "key", go.Binding.toString));document.location=(obj.part.data.link);} },  new go.Binding("text", "indi1",function(k){return " * " +"Voir les Fiches d'Indicateurs"+ " * ";}), { alignment: go.Spot.Center }, { font: "16px Ubuntu", stroke: "white", isUnderline:"underline" }, new go.Binding("isUnderline", "underline"),
		 { margin: 4 },)
));
  myFullDiagram.nodeTemplate = myNodeTemplate2;
  myLocalDiagram.nodeTemplate = myNodeTemplate;


  // Define a basic link template, not selectable, shared by both diagrams
  var myLinkTemplate =
	$(go.Link,
	  { routing: go.Link.Normal, selectable: false },
	  $(go.Shape,
		{ strokeWidth: 1 })
	);
  myFullDiagram.linkTemplate = myLinkTemplate;
  myLocalDiagram.linkTemplate = myLinkTemplate;

  // Create the full tree diagram
  setupDiagram();

  // Create a part in the background of the full diagram to highlight the selected node
  highlighter =
	$(go.Part, "Auto",
	  {
		layerName: "Background",
		selectable: true,
		isInDocumentBounds: false,
		locationSpot: go.Spot.Center
	  },
	  $(go.Shape, "Ellipse",
		{
		  fill: $(go.Brush, "Radial", { 0.0: "orange", 1.0: "white" }),
		  stroke: null,
		  desiredSize: new go.Size(200, 200)
		})
	);
  myFullDiagram.add(highlighter);

  // Start by focusing the diagrams on the node at the top of the tree.
  // Wait until the tree has been laid out before selecting the root node.
  myFullDiagram.addDiagramListener("InitialLayoutCompleted", e => {
	var node0 = myFullDiagram.findPartForKey(0);
	if (node0 !== null) node0.isSelected = true;
	showLocalOnFullClick();
  });

myFullDiagram.commitTransaction("highlight search");
//myFullDiagram.makeImage();
img_absol = myFullDiagram.makeImage({
		 scale: 1,
		 background: "AntiqueWhite"
	  });



//ImgBlock.innerHTML += "<img src='"+img_absol.src+"'> ";

}

// Make the corresponding node in the full diagram to that selected in the local diagram selected,
// then call showLocalOnFullClick to update the local diagram.
function showLocalOnLocalClick() {
  var selectedLocal = myLocalDiagram.selection.first();
  if (selectedLocal !== null) {
	// there are two separate Nodes, one for each Diagram, but they share the same key value
	myFullDiagram.select(myFullDiagram.findPartForKey(selectedLocal.data.key));
  }
}

function showLocalOnFullClick() {
  var node = myFullDiagram.selection.first();

  if (node !== null) {
	// make sure the selected node is in the viewport
	myFullDiagram.scrollToRect(node.actualBounds);
	// move the large yellow node behind the selected node to highlight it
	highlighter.location = node.location;
	// create a new model for the local Diagram
	var model = new go.TreeModel();
	// add the selected node and its children and grandchildren to the local diagram
	var nearby = node.findTreeParts(3);  // three levels of the (sub)tree
	// add parent and grandparent
	var parent = node.findTreeParentNode();
	if (parent !== null) {
	  nearby.add(parent);
	  var grandparent = parent.findTreeParentNode();
	  if (grandparent !== null) {
		nearby.add(grandparent);
	  }
	}
	// create the model using the same node data as in myFullDiagram's model
	nearby.each(n => {
	  if (n instanceof go.Node) model.addNodeData(n.data);
	});
	myLocalDiagram.model = model;
	// select the node at the diagram's focus
	var selectedLocal = myLocalDiagram.findPartForKey(node.data.key);
	if (selectedLocal !== null) selectedLocal.isSelected = true;
  }
}

// Create the tree model containing TOTAL nodes, with each node having a variable number of children
function setupDiagram(total) {
  if (total === undefined) total = {{this_entities.count}};  // default to 100 nodes
  var nodeDataArray = [];
  var colors = [];
  var color_i = 0;
  nodeDataArray.push({
	  key: 0,
	  color: "gray",
	  name:"{{actual_institution}}".replace("&#x27;","' "),
	  objectif:'{{actual_institution.nom}}'.replace("&#x27;","' ")
  });

  colors.push("#dark");colors.push("#0073b0");colors.push("#00c340");colors.push("blue");colors.push("#f98903");
  colors.push("#0f68a3");colors.push("brown");
  {% for enti in this_entities %}
  i_color = ({{forloop.counter}} % colors.length);
  {% for line in enti.m_entity_type.lines %}
	nodeDataArray.push({
	  key: {{line.id}},
	  color: {% if line.progression < 26 %} "blue" {% elif line.progression < 71 %} "orange" {% else %} "green" {% endif %},
	  name:"{{line.get_name}}".replace("&#x27;","' "),
	  link:"/indic/{{line.id}}",
	  {% if line.get_objectif != None %}objectif:"Objectif : {{line.get_objectif}}".replace("&#x27;","' ") + "\n"+"Progression : {{line.progression}} %",{% else %}objectif:"Progression : {{line.progression}} %",{% endif %}
	  {% for indi in line.get_indicateurs %}
	  indi{{forloop.counter}}:"{{indi}}",
	  {% endfor %}
	  {% if line.sup_entity != None %} parent:{{line.sup_entity.id}} {% else %} parent:0 {% endif %}
	});
  {% endfor %}
  var j = 0;
  for (var i = 1; i < total; i++) {
	var data = nodeDataArray[i];
	//data.parent = j;
	if (Math.random() < 0.3) j++;  // this controls the likelihood that there are enough children
  }
  {% endfor %}
  
  myFullDiagram.model = new go.TreeModel(nodeDataArray);

}

window.addEventListener('DOMContentLoaded', init);

// the Search functionality highlights all of the nodes that have at least one data property match a RegExp
function searchDiagram() {
  //alert("dfd")
  
  // called by button
  var input = document.getElementById("mySearch");
  if (!input) return;
  console.log(myFullDiagram.findNodesByExample({name:function(n){return n == input.value;}}))
  myFullDiagram.focus();

  myFullDiagram.startTransaction("highlight search");

  if (input.value) {
	// search four different data properties for the string, any of which may match for success
	// create a case insensitive RegExp from what the user typed
	var safe = input.value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	var regex = new RegExp(safe, "i");
	var results = myFullDiagram.findNodesByExample({ text: regex },
	  { nation: regex },
	  { title: regex },
	  { headOf: regex },
	  { objectif: regex});
	myFullDiagram.highlightCollection(results);
	// try to center the diagram at the first node that was found
	if (results.count > 0) myFullDiagram.centerRect(results.first().actualBounds);
  } else {  // empty string only clears highlighteds collection
	myFullDiagram.clearHighlighteds();
}



}



function printTree(num,prec="#"){
  a = document.getElementById("print_link")
  a.style = "display: none";
  a.href = img_absol.src;
  a.download = "Chaine de Resultats";
  a.click();
}


window.addEventListener('DOMContentLoaded', init);
</script>
{% block script_rapport %}

{% endblock %}

{% endblock %}
